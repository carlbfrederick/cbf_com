---
title: Uncovering the relationships among functions in a package
author: ~
date: '2018-01-28'
slug: uncovering-the-relationships-among-functions-in-a-package
categories:
  - R
tags:
  - networks
  - data-viz
  - packages
  - DiagrammeR

draft: TRUE
---

<script src="/rmarkdown-libs/htmlwidgets/htmlwidgets.js"></script>
<script src="/rmarkdown-libs/viz/viz.js"></script>
<link href="/rmarkdown-libs/DiagrammeR-styles/styles.css" rel="stylesheet" />
<script src="/rmarkdown-libs/grViz-binding/grViz.js"></script>


<p>For my inaugural post, I thought I’d share a function I wrote that visualizes the relationship between functions in a package. Aside from random curiosity, the purpose of this exercise was to understand the internal architecture of an internal package that I was updating at work. The functions are available at <a href="https://gist.github.com/carlbfrederick/b30d861ea80a27fad4e44623c41e0170">this gist</a>.</p>
<p>The end results are:</p>
<div id="htmlwidget-1" style="width:672px;height:480px;" class="grViz html-widget"></div>
<script type="application/json" data-for="htmlwidget-1">{"x":{"diagram":"digraph {\n\ngraph [layout = \"dot\",\n       outputorder = \"edgesfirst\",\n       bgcolor = \"white\",\n       rankdir = \"LR\"]\n\nnode [fontname = \"Helvetica\",\n      fontsize = \"10\",\n      shape = \"circle\",\n      fixedsize = \"false\",\n      width = \"0.5\",\n      style = \"filled\",\n      fillcolor = \"aliceblue\",\n      color = \"gray70\",\n      fontcolor = \"gray50\"]\n\nedge [fontname = \"Helvetica\",\n     fontsize = \"8\",\n     len = \"1.5\",\n     color = \"gray80\",\n     arrowsize = \"0.5\"]\n\n  \"1\" [label = \"averageObs\", fontsize = \"20\", shape = \"rectangle\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"4\" [label = \"buildModelMatrix\", fontsize = \"20\", shape = \"rectangle\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"5\" [label = \"collapseFrame\", fontsize = \"20\", shape = \"rectangle\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"7\" [label = \"draw.merMod\", fontsize = \"20\", shape = \"rectangle\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"8\" [label = \"easyVarCorr\", fontsize = \"20\", shape = \"rectangle\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"9\" [label = \"expectedRank\", fontsize = \"20\", shape = \"rectangle\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"10\" [label = \"fastdisp\", fontsize = \"20\", shape = \"rectangle\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"12\" [label = \"findFormFuns\", fontsize = \"20\", shape = \"rectangle\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"18\" [label = \"mkNewReTrms\", fontsize = \"20\", shape = \"rectangle\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"19\" [label = \"modelFixedEff\", fontsize = \"20\", shape = \"rectangle\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"24\" [label = \"predictInterval\", fontsize = \"20\", shape = \"rectangle\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"25\" [label = \"print.merModList\", fontsize = \"20\", shape = \"rectangle\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"26\" [label = \"randomObs\", fontsize = \"20\", shape = \"rectangle\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"29\" [label = \"REimpact\", fontsize = \"20\", shape = \"rectangle\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"30\" [label = \"reOnly\", fontsize = \"20\", shape = \"rectangle\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"31\" [label = \"REquantile\", fontsize = \"20\", shape = \"rectangle\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"33\" [label = \"residDF.merMod\", fontsize = \"20\", shape = \"rectangle\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"37\" [label = \"RHSForm\", fontsize = \"20\", shape = \"rectangle\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"41\" [label = \"setup_parallel\", fontsize = \"20\", shape = \"rectangle\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"44\" [label = \"stripAttributes\", fontsize = \"20\", shape = \"rectangle\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"46\" [label = \"subsetList\", fontsize = \"20\", shape = \"rectangle\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"47\" [label = \"superFactor\", fontsize = \"20\", shape = \"rectangle\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"51\" [label = \"wiggle\", fontsize = \"20\", shape = \"rectangle\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"1\"->\"12\" \n  \"1\"->\"31\" \n  \"1\"->\"44\" \n  \"1\"->\"46\" \n  \"1\"->\"47\" \n  \"4\"->\"18\" \n  \"4\"->\"30\" \n  \"4\"->\"37\" \n  \"7\"->\"1\" \n  \"7\"->\"26\" \n  \"10\"->\"8\" \n  \"12\"->\"5\" \n  \"24\"->\"4\" \n  \"24\"->\"33\" \n  \"24\"->\"41\" \n  \"25\"->\"19\" \n  \"26\"->\"44\" \n  \"26\"->\"46\" \n  \"26\"->\"47\" \n  \"29\"->\"9\" \n  \"29\"->\"24\" \n  \"51\"->\"47\" \n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
<p>The first two functions get the names of the functions from a namespace (using <code>lsf.str</code>) and cycles through each to which of the others that it calls.</p>
<pre class="r"><code>ls_fcns &lt;- function(pkg) {
  fcns &lt;- unclass(lsf.str(envir = asNamespace(pkg), all = TRUE))
  return(as.character(fcns))
}

fcn_deps &lt;- function(pkg) {
  fcns &lt;- ls_fcns(pkg)
  out &lt;- data.frame(Function = as.character(),
                    Dependency_Function = as.character(),
                    Number_Calls = as.integer())
  for (i in fcns) {
    this_fcn &lt;- capture.output(getAnywhere(i))
    for (j in fcns[-grep(i, fcns)]) {
      dep_fcns &lt;- grep(paste(j, &quot;\\(&quot;, sep=&quot;&quot;), this_fcn)
      if (length(dep_fcns &gt; 0)) {
        out &lt;- rbind(out,
                     data.frame(Function = i,
                                Dependency_Function = j,
                                Number_Calls = length(dep_fcns)))
      }
    }
  }
  return(out)
}</code></pre>
<p>The third function produces the <code>DiagrammeR</code> dgr_graph object that can be plotted. It is definitely “hacky” and will throw some errors that I haven’t quite ironed out yet.</p>
<pre class="r"><code>plotFcnDependencies &lt;- function(pkg) {
  fcns &lt;- ls_fcns(pkg)
  depFcn &lt;- fcn_deps(pkg)

  depth &lt;- NULL

  for (i in fcns) {
    try(suppressWarnings(dist &lt;- max(sapply(igraph::shortest_paths(igraph::graph_from_data_frame(depFcn[,1:2]), from = i)$vpath, length))))
    depth &lt;- c(depth, dist)
    dist &lt;- 0
  }

  nodes &lt;- data.frame(nodes = fcns,
                      type = &quot;&quot;,
                      label = htmltools::htmlEscape(fcns),
                      depth = depth)

  nodes &lt;- dplyr::arrange(nodes, desc(depth))


  out &lt;- DiagrammeR::create_graph(
    nodes_df = nodes,
    edges_df = DiagrammeR::create_edges(
      from = depFcn$Function,
      to = depFcn$Dependency_Function,
      rel = &quot;leading_to&quot;
    ),
    graph_name = paste(pkg, &quot; (version &quot;, packageVersion(pkg), &quot;) Function Map&quot;, sep=&quot;&quot;),
    graph_attrs = c(&quot;layout = dot&quot;, &quot;rankdir = LR&quot;),
    node_attrs = &quot;fontsize = 20&quot;
  )

  return(out)
}</code></pre>
<pre class="r"><code>sessionInfo()</code></pre>
<pre><code>## R version 3.3.2 (2016-10-31)
## Platform: x86_64-apple-darwin13.4.0 (64-bit)
## Running under: macOS Sierra 10.12.6
## 
## locale:
## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8
## 
## attached base packages:
## [1] methods   stats     graphics  grDevices utils     datasets  base     
## 
## other attached packages:
##  [1] bindrcpp_0.2     DiagrammeR_0.9.3 forcats_0.2.0    stringr_1.2.0   
##  [5] dplyr_0.7.4      purrr_0.2.4      readr_1.1.1      tidyr_0.7.2     
##  [9] tibble_1.4.1     ggplot2_2.2.1    tidyverse_1.2.1 
## 
## loaded via a namespace (and not attached):
##  [1] nlme_3.1-128       lubridate_1.7.1    devtools_1.12.0   
##  [4] RColorBrewer_1.1-2 httr_1.3.1         rprojroot_1.3-2   
##  [7] tools_3.3.2        backports_1.1.2    R6_2.2.2          
## [10] DT_0.2             lazyeval_0.2.0     colorspace_1.3-2  
## [13] withr_1.0.2        gridExtra_2.3      mnormt_1.5-5      
## [16] curl_3.1           cli_1.0.0          rvest_0.3.2       
## [19] xml2_1.1.1         influenceR_0.1.0   bookdown_0.5      
## [22] scales_0.5.0       mvtnorm_1.0-5      psych_1.7.3.21    
## [25] blme_1.0-4         digest_0.6.12      foreign_0.8-67    
## [28] minqa_1.2.4        rmarkdown_1.8      pkgconfig_2.0.1   
## [31] htmltools_0.3.6    lme4_1.1-12        htmlwidgets_1.0   
## [34] rlang_0.1.6        readxl_1.0.0       rstudioapi_0.7    
## [37] shiny_1.0.5        bindr_0.1          visNetwork_2.0.3  
## [40] jsonlite_1.5       rgexf_0.15.3       magrittr_1.5      
## [43] Matrix_1.2-7.1     Rcpp_0.12.13       munsell_0.4.3     
## [46] abind_1.4-5        viridis_0.4.1      stringi_1.1.5     
## [49] yaml_2.1.16        merTools_0.3.0     MASS_7.3-45       
## [52] plyr_1.8.4         grid_3.3.2         parallel_3.3.2    
## [55] crayon_1.3.4       lattice_0.20-34    haven_1.1.0       
## [58] splines_3.3.2      hms_0.3            knitr_1.18.10     
## [61] pillar_1.1.0       igraph_1.1.2       reshape2_1.4.2    
## [64] XML_3.98-1.5       glue_1.2.0         evaluate_0.10.1   
## [67] blogdown_0.5       downloader_0.4     modelr_0.1.1      
## [70] nloptr_1.0.4       httpuv_1.3.5       cellranger_1.1.0  
## [73] gtable_0.2.0       assertthat_0.2.0   xfun_0.1          
## [76] mime_0.5           xtable_1.8-2       broom_0.4.2       
## [79] coda_0.19-1        viridisLite_0.2.0  arm_1.9-3         
## [82] memoise_1.0.0      Rook_1.1-1         brew_1.0-6</code></pre>
